(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1706],{3574:function(n,s,e){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/2023-10-11-oracle-split-read",function(){return e(1662)}])},1662:function(n,s,e){"use strict";e.r(s),e.d(s,{useTOC:function(){return a}});var l=e(2676),i=e(8051),d=e(4906),r=e(3459);function a(n){let s={code:"code",...(0,r.a)()};return[{value:"测试环境",id:"测试环境",depth:2},{value:"硬件",id:"硬件",depth:3},{value:"数据",id:"数据",depth:3},{value:"测试验证",id:"测试验证",depth:2},{value:"A: 基于主键/索引列，按照(min, max)区间切分",id:"a-基于主键索引列按照min-max区间切分",depth:3},{value:"B: 基于ROWID，按照(min, max)区间切分",id:"b-基于rowid按照min-max区间切分",depth:3},{value:"C: 基于ROWID，Scan, split by rows",id:"c-基于rowidscan-split-by-rows",depth:3},{value:(0,l.jsxs)(l.Fragment,{children:["D: ",(0,l.jsx)(s.code,{children:"DBMS_PARALLEL_EXECUTE"}),"包",(0,l.jsx)(s.code,{children:"create_chunks_by_rowid"})]}),id:"d-dbms_parallel_execute包create_chunks_by_rowid",depth:3},{value:"E: 基于ROWID，Hash切分",id:"e-基于rowidhash切分",depth:3},{value:"结论",id:"结论",depth:2}]}s.default=(0,i.c)(function(n){let{toc:s=a(n)}=n,e={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",span:"span",strong:"strong",sup:"sup",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.a)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h2,{id:s[0].id,children:s[0].value}),"\n",(0,l.jsx)(e.h3,{id:s[1].id,children:s[1].value}),"\n",(0,l.jsx)(e.h3,{id:s[2].id,children:s[2].value}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"表结构"})}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"CREATE TABLE TPCH.FP_RAW_DATA"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"("})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    CP_IDX   number(20, 0)    not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    WAFERID  varchar(10)      not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN      number(10, 0)    not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    SITE     DOUBLE PRECISION,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    X        DOUBLE PRECISION not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    Y        DOUBLE PRECISION not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN_1    DOUBLE PRECISION not null,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN_2    DOUBLE PRECISION,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN_3    DOUBLE PRECISION,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    -- BIN_4 ~ BIN_39 DOUBLE PRECISION"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN_40   DOUBLE PRECISION,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    BIN_CODE VARCHAR(10)"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:");"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"CREATE UNIQUE INDEX TPCH.FP_RAW_IDX2 ON TPCH.FP_RAW_DATA (CP_IDX, WAFERID, X, Y);"})})]})}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"准备20,000万（2亿）行数据"})}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT TABLE_NAME"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , NUM_ROWS"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , AVG_ROW_LEN"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , ROUND(AVG_ROW_LEN * NUM_ROWS / 1024 / 1024 / 1024, 2) AS GB"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM ALL_TABLES"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"where OWNER = 'TPCH'"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"  AND TABLE_NAME = 'FP_RAW_DATA_MARS3'"})})]})}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"shell","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"TABLE_NAME"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"--------------------------------------------------------------------------------"})}),"\n",(0,l.jsxs)(e.span,{children:[(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"  NUM_ROWS"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:" AVG_ROW_LEN"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:"	       GB"})]}),"\n",(0,l.jsxs)(e.span,{children:[(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"----------"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" -----------"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" ----------"})]}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"FP_RAW_DATA_MARS3"})}),"\n",(0,l.jsxs)(e.span,{children:[(0,l.jsx)(e.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" 200000000"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:"	    99"}),(0,l.jsx)(e.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:"	    18.44"})]})]})}),"\n",(0,l.jsx)(e.p,{children:"分16个分片进行，平均每个分片处理12,500,000（1250万）行数据"}),"\n",(0,l.jsxs)(e.p,{children:["脚注",(0,l.jsx)(e.sup,{children:(0,l.jsx)(e.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":"","aria-describedby":"footnote-label",children:"1"})})]}),"\n",(0,l.jsx)(e.h2,{id:s[3].id,children:s[3].value}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{style:{textAlign:"center"},children:"编号"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"切分字段"}),(0,l.jsx)(e.th,{style:{textAlign:"left"},children:"切分方法"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"center"},children:"A"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"CP_IDX"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"Range: (Minimum, Maximum)"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"center"},children:"B"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"ROWID"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"Range: (Minimum, Maximum)"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"center"},children:"C"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"ROWID"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"Range: Scan"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"center"},children:"D"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"ROWID"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"Range: DBMS_PARALLEL_EXECUTE.create_chunks_by_rowid"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{style:{textAlign:"center"},children:"E"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"ROWID"}),(0,l.jsx)(e.td,{style:{textAlign:"left"},children:"Hash"})]})]})]}),"\n",(0,l.jsx)(e.h3,{id:s[4].id,children:s[4].value}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT /*+parallel(4)*/"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    COUNT(1)       AS total"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , MIN(CP_IDX) AS lower"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , MAX(CP_IDX) AS upper"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM TPCH.FP_RAW_DATA;"})})]})}),"\n",(0,l.jsx)(e.h3,{id:s[5].id,children:s[5].value}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT /*+parallel(4)*/"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    COUNT(1)      AS total"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , MIN(ROWID) AS lower"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"     , MAX(ROWID) AS upper"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM TPCH.FP_RAW_DATA;"})})]})}),"\n",(0,l.jsx)(e.h3,{id:s[6].id,children:s[6].value}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT /*+parallel(4)*/ id"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM (SELECT id, ROWNUM AS rn"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"      FROM (SELECT ROWID AS id"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            FROM TPCH.FP_RAW_DATA"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            ORDER BY ROWID) t) x"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"WHERE MOD(rn, 12500000) = 0"})})]})}),"\n",(0,l.jsx)(e.h3,{id:s[7].id,children:s[7].value}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"BEGIN"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    DBMS_PARALLEL_EXECUTE.create_task(task_name => 'tpch_test');"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"    DBMS_PARALLEL_EXECUTE.create_chunks_by_rowid("})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            task_name => 'tpch_test',"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            table_owner => 'TPCH',"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            table_name => 'FP_RAW_DATA',"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            by_row => TRUE,"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"            chunk_size => 12500000);"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"END;"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"/"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT chunk_id, status, start_rowid, end_rowid"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM user_parallel_execute_chunks"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"WHERE task_name = 'tpch_test'"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"ORDER BY chunk_id;"})})]})}),"\n",(0,l.jsx)(e.h3,{id:s[8].id,children:s[8].value}),"\n",(0,l.jsx)(e.pre,{tabIndex:"0","data-language":"oraclesqlplus","data-word-wrap":"",children:(0,l.jsxs)(e.code,{children:[(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"SELECT *"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"FROM TPCH.FP_RAW_DATA"})}),"\n",(0,l.jsx)(e.span,{children:(0,l.jsx)(e.span,{children:"WHERE MOD(DBMS_ROWID.ROWID_ROW_NUMBER(TPCH.FP_RAW_DATA.ROWID), 16) = 0"})})]})}),"\n",(0,l.jsx)(e.h2,{id:s[9].id,children:s[9].value}),"\n",(0,l.jsx)(e.p,{children:":::tip\nLorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque elementum dignissim ultricies. Fusce rhoncus ipsum\ntempor eros aliquam consequat. Lorem ipsum dolor sit amet\n:::"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["在我们的场景中，允许",(0,l.jsx)(e.code,{children:"Partitioned Table"}),"?"]}),"\n",(0,l.jsxs)(e.li,{children:["优先使用 ",(0,l.jsx)(e.code,{children:"DBMS_PARALLEL_EXECUTE"}),"包中的",(0,l.jsx)(e.code,{children:"create_chunks_by_rowid"}),"方法，获取基于",(0,l.jsx)(e.code,{children:"ROWID"}),"切分；"]}),"\n",(0,l.jsx)(e.li,{children:"如果因为版本兼容性或者权限等原因导致1失败，则尝试采用；"}),"\n",(0,l.jsx)(e.li,{children:"啦啦啦"}),"\n"]}),"\n",(0,l.jsxs)(e.section,{"data-footnotes":"",className:"footnotes",children:[(0,l.jsx)(e.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{id:"user-content-fn-1",children:["\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.a,{href:"https://docs.oracle.com/en/database/oracle/oracle-database/19/arpls/DBMS_PARALLEL_EXECUTE.html",children:"Oracle DBMS_PARALLEL_EXECUTE"})," ",(0,l.jsx)(e.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"↩"})]}),"\n"]}),"\n"]}),"\n"]})]})},"/blog/2023-10-11-oracle-split-read",{filePath:"pages/blog/2023-10-11-oracle-split-read.md",timestamp:172853319e4,pageMap:d.v,frontMatter:{slug:"oracle-split-read",title:"Oracle大表的并行读取",authors:["aleafs"],image:"http://www.oracle.com/node/oce/storyhub/prod/api/v1.1/assets/CONT2211A10520EB41FBA9E95AA892CCEE34/native/rh08-oracle-for-azure-732x372.jpg",tags:["Oracle","ROWID","并行"]},title:"Oracle大表的并行读取"},"undefined"==typeof RemoteContent?a:RemoteContent.useTOC)}},function(n){n.O(0,[9882,5982,2888,9774,179],function(){return n(n.s=3574)}),_N_E=n.O()}]);